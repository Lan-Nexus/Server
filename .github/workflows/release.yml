name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.0, v1.2.3, etc.
  pull_request: # Triggers on pull requests

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            tagName="${{ github.ref_name }}"
            version="${tagName#v}"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Extracted version: $version"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="0.0.0-pr-${{ github.event.pull_request.number }}"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Using PR version: $version"
          else
            version="0.0.0-dev"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Using development version: $version"
          fi

      - name: Update package.json version (temporary for build)
        run: |
          version="${{ steps.get_version.outputs.version }}"
          jq --arg v "$version" '.version = $v' package.json > package.tmp.json
          mv package.tmp.json package.json
          echo "Updated package.json version to: $version (temporary for build only)"

      - name: Install server dependencies
        run: npm ci

      - name: Build Server
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy .env.example to build directory
        run: cp .env.example dist/.env

      - name: Copy package files and Dockerfile to build directory
        run: |
          cp package.json dist/package.json
          cp package-lock.json dist/package-lock.json
          cp Dockerfile dist/Dockerfile

      - name: Get build size
        id: build_size
        run: |
          size=$(du -sh dist | cut -f1)
          echo "size=$size" >> "$GITHUB_OUTPUT"
          echo "Build size: $size"

      - name: Upload build artifact for PR
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: server-build-pr-${{ github.event.pull_request.number }}
          path: dist/
          retention-days: 30

      - name: Get artifact download URL
        if: github.event_name == 'pull_request'
        id: artifact_url
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            const artifact = artifacts.data.artifacts.find(a => a.name === 'server-build-pr-${{ github.event.pull_request.number }}');
            if (artifact) {
              return artifact.id;
            }
            return '';
          result-encoding: string

      - name: Comment on PR with build artifact
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.get_version.outputs.version }}';
            const buildSize = '${{ steps.build_size.outputs.size }}';
            const runId = context.runId;
            const repo = context.repo;
            const prNumber = context.issue.number;
            const artifactId = '${{ steps.artifact_url.outputs.result }}';
            
            const downloadUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}/artifacts/${artifactId}`;
            
            const comment = `## üöÄ Server Build Ready
            
            **Version:** \`${version}\`
            **Build Size:** ${buildSize}
            
            üì¶ **[‚¨áÔ∏è Download server-build.zip](${downloadUrl})**
            
            ### Included Files:
            - ‚úÖ Compiled server code
            - ‚úÖ \`package.json\`
            - ‚úÖ \`package-lock.json\`
            - ‚úÖ \`Dockerfile\`
            - ‚úÖ \`.env.example\`
            
            ---
            *Build completed successfully* ‚ú®`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: comment
            });

      - name: Zip Build for Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          cd dist
          zip -r ../server-build.zip .

      - name: Upload release assets
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            server-build.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}