name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.0, v1.2.3, etc.
  pull_request: # Triggers on pull requests

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            tagName="${{ github.ref_name }}"
            version="${tagName#v}"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Extracted version: $version"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="0.0.0-pr-${{ github.event.pull_request.number }}"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Using PR version: $version"
          else
            version="0.0.0-dev"
            echo "version=$version" >> "$GITHUB_OUTPUT"
            echo "Using development version: $version"
          fi

      - name: Update package.json version (temporary for build)
        run: |
          version="${{ steps.get_version.outputs.version }}"
          jq --arg v "$version" '.version = $v' package.json > package.tmp.json
          mv package.tmp.json package.json
          echo "Updated package.json version to: $version (temporary for build only)"

      - name: Install server dependencies
        run: npm ci

      - name: Build Server
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy .env.example to build directory
        run: cp .env.example dist/.env

      - name: Copy package files and Dockerfile to build directory
        run: |
          cp package.json dist/package.json
          cp package-lock.json dist/package-lock.json
          cp Dockerfile dist/Dockerfile

      - name: Zip Build
        run: |
          cd dist
          zip -r ../server-build.zip .

      - name: Upload build artifact for PR
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: server-build-pr-${{ github.event.pull_request.number }}
          path: server-build.zip
          retention-days: 30

      - name: Comment on PR with build artifact
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const version = '${{ steps.get_version.outputs.version }}';
            const runId = context.runId;
            const repo = context.repo;
            
            const stats = fs.statSync('server-build.zip');
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            const comment = `## ðŸš€ Server Build Ready
            
            **Version:** \`${version}\`
            **Build Size:** ${fileSizeInMB} MB
            
            ðŸ“¦ **Download Build Artifact:**
            [server-build-pr-${{ github.event.pull_request.number }}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
            
            ### Included Files:
            - âœ… Compiled server code
            - âœ… \`package.json\`
            - âœ… \`package-lock.json\`
            - âœ… \`Dockerfile\`
            - âœ… \`.env.example\`
            
            ---
            *Build completed successfully* âœ¨`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: comment
            });

      - name: Upload release assets
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            server-build.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}